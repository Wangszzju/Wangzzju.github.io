## 1. 背景
近期对反馈后台进行了重构，将原先的“论坛－帖子”形式，修改成了IM形式（定时刷新）。

除此以外，主要的功能变化有三个：

* 支持上传图片
* 支持添加文字链接
* 当搜索某个已注册但未提交过反馈的用户时，会为其自动创建IM对话列表

## 2. 业务层

### 2.1 进度
本次预估时间分片
* 列表重构2天
* 群发需求2天

实际时间
* 列表重构1.5天
* 图片上传1天
* 文字链实现0.5天

但是实际进度仍然和预估进度差不多，其原因在于中间由于举报后台要按期上线，所以中间去做了1.5天的举报后台

但是，这个后台本来应该早就做好了。这可以抽象成一个问题：
> 当因为后端接口不匹配，而导致开发进度滞后，怎么办？

首先，当然是排序，要弄清楚哪个需求如果不做，危害会更大。

其次是沟通，要对接口的输入值／返回值进行明确（可以基于视觉稿判断需要），防止反复沟通

### 2.2 符合度

另外，这次在测试版本上线以后，从使用方传来了各种需求，差点忍不住就想在当前版本改动了。

但并不应该这样做，要知道，需求是无穷无尽的，使用者在看到新的产品后，会向大脑输入新的信息，进而产生新的需求，不可能把所有需求都在当前版本做完。就算看上去是一个很小的需求，但也可能因为贸然加入，而对以后的代码维护造成困难。

那么，问题抽象就是：
> 什么样的需求，可以在测试之后，在当前版本立即改动？

对此有几点想法：
* 如果是bug，立即修复
* 需要基于原有功能优化，但不影响基本使用的，不改。
* 有大流量用户频繁访问的功能模块，如果有体验不畅之处，修复。
* 一次性的需求，可以不太考虑维护需要
* 尽量明确场景。


## 3. 技术层

### 3.1 新技术

#### [图片上传](http://gitlab.weixinzhuyi.com/tech/f2e/blob/master/dachui/daily/2017.3.6-3.12/%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0.md)

这次会了图片上传，但是还没有做图片压缩／多图上传／进度条，以后建议自己做一做。

#### [正则匹配懒惰模式](http://gitlab.weixinzhuyi.com/tech/f2e/blob/master/dachui/daily/2017.3.6-3.12/%E6%96%87%E5%AD%97%E9%93%BE%E7%94%9F%E6%88%90.md)

还好写了单元测试，发现正则匹配要用懒惰模式。

#### 定时刷新仿IM

```
  setInterval(async function(){
    if(gFid){  // 判断当前是否有详情展示
      let resDataStr = await $.get(`/i/get-fu-detail/${gFid}`);
      let { data } = JSON.parse(resDataStr);
      if(data.msgs[0].createdAt !== gLastMsgTime){
        gLastMsgTime = data.msgs[0].createdAt;  // 更新最新时间
        data.msgs = processMsgs(data.msgs); // 文字链处理
        msgListNode.html(msgListTpl(data)); 
        log('现在的gLastMsgTime变更为:' + gLastMsgTime);
      }
      else{
        log('没变');
      }
    }
  },3000);
```

也想过是不是可以做数据双向绑定，这样的话一旦后台数据有更新，就可以自动同步，无需多次发送请求。但是，这样一来，复杂度就被留给数据了，对于这么一个并发程度很低的项目来讲，复杂度还是留给前端比较好。

### 3.2 不好的地方

#### [代码封装了过多流程](https://tower.im/projects/a40113bf31834dd3b22a5cc2f85d308d/messages/b0d4d7c3576e434798c987bb8b89b2bd/)

从这个项目里可以看到，我虽然在划分模块，但是实际上还是把流程拆成了多个文件而已，并没有一种“面向对象”的感觉。

而一个好的模块，其基本结构应该是：输入／功能／输出，最终指向“高内聚，低耦合”，但问题是：
> 什么是内聚，什么是耦合？

我有这样的理解
* 内聚：如果操作的对象是自己，那么这个操作方法，就写在对象内部。
* 耦合：如果A对象需要B对象去完成某件事，尽量通过传参调用B的某个方法来完成，换句话说“我告诉你要求，剩下的事情你自己去做”。

#### imageView使用的格式没有看清楚

首先，`/0/w/<LongEdge>/h/<ShortEdge>`和`/2/w/<Width>/h/<Height>`是不同的，前者是限制长短边，后者是限制宽高，这两者显然是不通的。

其次，imageView2接口支持的图片格式也就`psd、jpeg、png、gif、webp、tiff、bmp`，但是上传input按钮却没有做限制，应该修改一下accept属性。

## 4. 感想

首先，单元测试是个好东西，帮助提早发现了贪婪匹配的问题。

其次，不断深入某项技术会发现乐趣：比如纯CSS实现业务／图片上传的分片or压缩。

最后，下次要尝试按照对象化的方式来组织模块，不要进行封装流程的"伪模块化"。